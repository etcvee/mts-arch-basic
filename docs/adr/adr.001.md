# ADR.001 Категория системы
<!-- 
  Примечание для проверяющего:

  Я решил рассматривать подсистемы независимо друг от друга и для каждой из подсистем выбрать свою категорию.
  В связи с этим не очень понятно, как коротко описать суть в названии, т.к. принято несколько решений в разрезе каждой подсистемы.

-->

* Статус: Принято
* Владелец: ntkrnlmp@yandex.ru

## Контекст
Необходимо выбрать категорию системы (ACID/BASE/CAP/PACELC) с учетом нефункциональных требований и/или других ограничений:

*  QR.001 Производительность
*  QR.002 Масштабируемость
*  QR.003 Надежность
*  QR.004 Доступность

Т.к. требования, предъявляемые к подсистемам онлайн-трансляции и оценки докладов намного выше, чем требования, предъявляемые к подсистемам работы с докладчиками и расписанием, имеет смысл рассмотреть эти подсистемы независимо друг от друга.

## Варианты решения
Выбор осуществляется в двух категориях:

### Категория 1. ACID или BASE

#### Вариант 1. ACID
ACID - акроним от Atomicity, Consistency, Isolation, и Durability. В рамках этой модели гарантируется, что состояние системы изменяется атомарно (все изменения либо сохранены, либо нет), обеспечивается мгновенная консистентность данных на всех узлах системы, транзакции изолированы друг от друга, а изменения, выполненные в рамках транзакции, сохраняются в случае сбоя системы.

Обычно эта модель характеризуется синхронной репликацией данных. Модель является понятной для разработчиков и пользователей, т.к. с их точки зрения, система ведет себя предсказуемо (например, если пользователь сохранил данные, то он может сразу же увидеть их в пользовательском интерфейсе).

* **Плюсы**
  * Гарантия консистентности данных
  * Поведение системы понятно пользователю
* **Минусы**
  * Плохо масштабируется (горизонтально)

#### Вариант 2. BASE
BASE - акроним от Basic Availability, Soft-State и Eventual Consistency. В рамках этой модели гарантируется высокая доступность системы, отсутствует транзакционность и мгновенная консистентность данных (система придет к согласованному состоянию через некоторое время).

Обычно эта модель характеризуется асинхронной репликацией данных.

* **Плюсы**
  * Высокая доступность
  * Хорошо масштабируется (горизонтально)
* **Минусы**
  * Отсутствие гарантий консистетности данных
  * Поведение системы может быть неочевидным с точки зрения пользователя

### Категория 2. CAP (PACELC)

CAP - акроним от Consistency, Availability и Partition Tolerance. Согласно теореме, распределенная система может удовлетворять только двум из трех свойств, т.е CA, AP или CP. 

В распределенных системах Partition Tolerance является обязательным требованием, т.к. сеть не является надежным элементом и в процессе коммуникации узлов могут происходить задержки и сбои. Поэтому для таких систем выбор фактически осуществляется из AP и CP.

Некоторые системы иметь только одно свойство, например, только P. Если система построена на основе master/slave, то в случае потери связи с ведущим узлом, пользователь сможет продолжать читать из реплики, но не сможет писать в неё - требование к Availability не выполняется и система является только P. В случае асинхронной репликации клиент может прочитать данные из реплики раньше, чем они будут синхронизированы - нарушается требование к Consistency и в этом случае система так же является только P.

Основной недостаток теоремы в том, что она не определяет понятие "частичной доступности", а так же не учитывает время, необходимое для ответа системы. К примеру, системы класса CP, пытаясь прийти к согласованному состоянию, могут очень долго быть недоступными.

PACELC - теорема, расширяющая теорему CAP. Из теоремы следует, что в случае разделения сети, выбор стоит между Availability и Consistency, а в случае нормальной работы системы - между Latency и Consistency.

Под Latency понимается время, за которое клиент получает ответ. Таким образом Latency косвенно определяет степень доступности системы.

#### Вариант 1. CA
* **Плюсы**
  * Высокая доступность
  * Строгая консистентность (зависит от способа репликации)
* **Минусы**
  * Недоступность системы при разделении сети

#### Вариант 2. CP
* **Плюсы**
  * Согласованность данных
  * Устойчивость к разделению сети
* **Минусы**
  * Система может быть недоступной продолжительное время

#### Вариант 3. AP
* **Плюсы**
  * Высокая доступность
  * Устойчивость к разделению сети
* **Минусы**
  * Отсутствие строгой консистентности
  
#### Вариант 4. EL
* **Плюсы**
  * Высокая скорость ответа
  * Высокая доступность системы
* **Минусы**
  * Отсутствует строгая согласованность (согласованность в конечном счете)

#### Вариант 5. EC
* **Плюсы**
  * Строгая согласованность
* **Минусы**
  * Увеличенное время ответа системы
  * Сниженная доступность системы

## Решение
Для подсистемы работы с докладчиками и расписанием мы используем ACID и CA. Количество пользователей (экспертов, докладчиков), одновременно работающих с системой небольшое, высокая нагрузка не ожидается. В данном случае гораздо более важно обеспечить согласованность данных и их надежность, чтобы система не теряла пользовательские данные.

Для подсистемы онлайн-трансляции и оценки докладов мы используем вариант BASE и AP/EL. В данном случае ожидается много пользователей и большая нагрузка, поэтому важно обеспечить доступность системы и скорость ответа, а строгой согласованностью данных можно пренебречь. К примеру, недоступность трансляции из одного зала не должна приводить к невозможности просмотру трансляций из других залов. Строгая согласованность для сбора оценок доклада не требуется.

## Последствия

Выбор ACID и CA для подсистем работы с докладами и расписанием ограничивает способность этих подсистем к масштабированию. Исходя из текущих требований сильной нагрузки не ожидается, но требования к нагрузке могут измениться. В этом случае предполагается вносить элементы согласованности в конечном счете. Например, загрузку файлов можно будет масштабировать путем создания очередей на загрузку, из которых файлы будут постепенно загружаться в основное хранилище. Это потребует доработку системы в части уведомлений пользователя о том, что файл скоро будет загружен - иначе он не будет понимать, почему его файл не загрузился. При высокой нагрузке на чтение, например в случае с получением актуального расписания, планируется использовать асинхронную репликацию в AP/EL базу данных.

